name: Release

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  release-zip:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"

      - name: Install production dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction

      - name: Create release zip
        run: |
          mkdir -p build/blockstudio
          rsync -a --exclude='.git' --exclude='node_modules' --exclude='tests' --exclude='docs' \
            --exclude='evals' --exclude='src' --exclude='.github' --exclude='_reference' \
            --exclude='.env*' --exclude='*.config.*' --exclude='tsconfig*' \
            --exclude='package.json' --exclude='package-lock.json' --exclude='.npmrc' \
            --exclude='.gitignore' --exclude='.prettierrc*' --exclude='eslint*' \
            --exclude='phpcs.xml*' --exclude='scoper.inc.php' --exclude='build.sh' \
            --exclude='CLAUDE.md' --exclude='.claude' --exclude='build' \
            . build/blockstudio/
          cd build && zip -r ../blockstudio.zip blockstudio/

      - name: Upload release asset
        run: gh release upload "${{ github.event.release.tag_name }}" blockstudio.zip --clobber
        env:
          GH_TOKEN: ${{ github.token }}
