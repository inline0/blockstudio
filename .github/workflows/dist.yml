name: Distribution

on:
  push:
    branches: [main, fix/composer-autoload-fatal]

concurrency:
  group: dist-${{ github.ref }}
  cancel-in-progress: true

jobs:
  zip-integrity:
    name: Zip integrity
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          extensions: dom, json, zip, simplexml, libxml, iconv

      - name: Install production dependencies
        run: composer install --no-dev --optimize-autoloader --no-interaction

      - name: Build zip
        run: |
          mkdir -p build/blockstudio
          rsync -a --exclude='.git' --exclude='node_modules' --exclude='/tests' --exclude='/docs' \
            --exclude='/evals' --exclude='/src' --exclude='.github' --exclude='_reference' \
            --exclude='.env*' --exclude='*.config.*' --exclude='tsconfig*' \
            --exclude='package.json' --exclude='package-lock.json' --exclude='.npmrc' \
            --exclude='.gitignore' --exclude='.prettierrc*' --exclude='eslint*' \
            --exclude='phpcs.xml*' --exclude='scoper.inc.php' --exclude='build.sh' \
            --exclude='CLAUDE.md' --exclude='.claude' --exclude='/build' \
            . build/blockstudio/
          cd build && zip -r ../blockstudio.zip blockstudio/

      - name: Verify required files exist
        run: |
          cd build/blockstudio
          for f in blockstudio.php readme.txt vendor/autoload.php lib/tailwindphp-autoload.php includes/class-plugin.php; do
            if [ ! -f "$f" ]; then
              echo "MISSING: $f"
              exit 1
            fi
          done
          for d in lib includes/classes includes/admin/assets; do
            if [ ! -d "$d" ]; then
              echo "MISSING DIR: $d"
              exit 1
            fi
          done
          echo "All required files present"

      - name: Verify no dev files leaked
        run: |
          cd build/blockstudio
          for f in node_modules tests docs evals .github _reference CLAUDE.md scoper.inc.php; do
            if [ -e "$f" ]; then
              echo "LEAKED: $f"
              exit 1
            fi
          done
          echo "No dev files leaked"

      - name: Verify PHP syntax
        run: |
          cd build/blockstudio
          find . -name '*.php' -print0 | xargs -0 -n1 php -l > /dev/null
          echo "All PHP files parse cleanly"

      - name: Verify autoloader resolves scoped classes
        run: |
          cd build/blockstudio
          php -r "
            require 'vendor/autoload.php';
            require 'lib/tailwindphp-autoload.php';
            \$classes = [
              'YahnisElsts\\\PluginUpdateChecker\\\v5\\\PucFactory',
              'BlockstudioVendor\\\MatthiasMullie\\\Minify\\\CSS',
              'BlockstudioVendor\\\ScssPhp\\\ScssPhp\\\Compiler',
              'BlockstudioVendor\\\League\\\Uri\\\Uri',
            ];
            foreach (\$classes as \$class) {
              if (!class_exists(\$class)) {
                echo \"MISSING CLASS: \$class\n\";
                exit(1);
              }
            }
            echo \"All scoped classes resolve\n\";
          "

      - name: Upload zip artifact
        uses: actions/upload-artifact@v4
        with:
          name: blockstudio-zip
          path: blockstudio.zip

  wordpress-activation:
    name: WordPress activation
    if: contains(github.event.head_commit.message, '[e2e]')
    needs: zip-integrity
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (for test theme)
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Download zip artifact
        uses: actions/download-artifact@v4
        with:
          name: blockstudio-zip

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          extensions: dom, json, zip, simplexml, libxml, iconv, mysqli
          tools: wp-cli

      - name: Start MySQL
        run: |
          sudo systemctl start mysql
          mysql -u root -proot -e "CREATE DATABASE IF NOT EXISTS wordpress;"

      - name: Download and install WordPress
        run: |
          mkdir wordpress && cd wordpress
          wp core download
          wp config create --dbname=wordpress --dbuser=root --dbpass=root
          wp core install --url=http://localhost --title=Test --admin_user=admin --admin_email=admin@test.com --admin_password=password --skip-email

      - name: Install and activate plugin from zip
        run: |
          cd wordpress
          wp plugin install ../blockstudio.zip --activate

      - name: Install test theme
        run: |
          cp -r repo/tests/theme wordpress/wp-content/themes/blockstudio-test
          cd wordpress
          wp theme activate blockstudio-test

      - name: Verify plugin is active
        run: |
          cd wordpress
          wp plugin list --status=active --field=name | grep -q blockstudio
          echo "Plugin is active"

      - name: Verify plugin loads without errors
        run: |
          cd wordpress
          wp eval "echo 'BLOCKSTUDIO_VERSION: ' . BLOCKSTUDIO_VERSION . PHP_EOL;"
          wp eval "echo 'Plugin class exists: ' . (class_exists('Blockstudio\\\Plugin') ? 'yes' : 'no') . PHP_EOL;"

      - name: Verify block detection
        run: |
          cd wordpress
          wp eval "
            \$registry = WP_Block_Type_Registry::get_instance();
            \$block = \$registry->get_registered('blockstudio/type-number');
            if (!\$block) {
              echo \"FAIL: blockstudio/type-number not registered\n\";
              exit(1);
            }
            echo \"Block registered: \" . \$block->name . \"\n\";
            echo \"Title: \" . \$block->title . \"\n\";
          "

  packagist-install:
    name: Packagist install
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (for test theme)
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          extensions: dom, json, zip, simplexml, libxml, iconv, mysqli
          tools: wp-cli

      - name: Install via Composer from Packagist
        run: |
          mkdir -p test-project && cd test-project
          composer init --no-interaction --name=test/blockstudio-packagist
          composer config allow-plugins.composer/installers true
          composer require blockstudio/blockstudio --no-interaction

      - name: Verify package installed
        run: |
          cd test-project
          test -f vendor/blockstudio/blockstudio/blockstudio.php
          echo "Plugin files installed from Packagist"

      - name: Verify autoloader resolves classes
        run: |
          cd test-project
          php -r "
            require 'vendor/autoload.php';
            require 'vendor/blockstudio/blockstudio/lib/tailwindphp-autoload.php';
            if (!class_exists('YahnisElsts\\\PluginUpdateChecker\\\v5\\\PucFactory')) {
              echo \"PucFactory not found\n\";
              exit(1);
            }
            echo \"Packagist install: classes resolve\n\";
          "

      - name: Start MySQL
        run: |
          sudo systemctl start mysql
          mysql -u root -proot -e "CREATE DATABASE IF NOT EXISTS wordpress;"

      - name: Set up WordPress with Packagist-installed plugin
        run: |
          mkdir wordpress && cd wordpress
          wp core download
          wp config create --dbname=wordpress --dbuser=root --dbpass=root
          wp core install --url=http://localhost --title=Test --admin_user=admin --admin_email=admin@test.com --admin_password=password --skip-email
          ln -s $GITHUB_WORKSPACE/test-project/vendor/blockstudio/blockstudio wp-content/plugins/blockstudio
          wp plugin activate blockstudio

      - name: Install test theme and verify block detection
        run: |
          cp -r repo/tests/theme wordpress/wp-content/themes/blockstudio-test
          cd wordpress
          wp theme activate blockstudio-test
          wp eval "
            \$registry = WP_Block_Type_Registry::get_instance();
            \$block = \$registry->get_registered('blockstudio/type-number');
            if (!\$block) {
              echo \"FAIL: blockstudio/type-number not registered\n\";
              exit(1);
            }
            echo \"Block registered: \" . \$block->name . \"\n\";
            echo \"Title: \" . \$block->title . \"\n\";
          "

  composer-install:
    name: Composer install
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (for test theme)
        uses: actions/checkout@v4
        with:
          path: repo

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.4"
          extensions: dom, json, zip, simplexml, libxml, iconv, mysqli
          tools: wp-cli

      - name: Create test project
        run: |
          mkdir -p test-project
          cd test-project
          cat > composer.json << 'COMPOSER'
          {
            "repositories": [
              {
                "type": "vcs",
                "url": "https://github.com/${{ github.repository }}"
              }
            ],
            "require": {
              "blockstudio/blockstudio": "dev-${{ github.ref_name }}"
            },
            "config": {
              "allow-plugins": {
                "composer/installers": true,
                "dealerdirect/phpcodesniffer-composer-installer": true
              }
            }
          }
          COMPOSER

      - name: Install via Composer
        run: |
          cd test-project
          composer install --no-interaction --prefer-dist
        env:
          COMPOSER_AUTH: '{"github-oauth": {"github.com": "${{ secrets.GITHUB_TOKEN }}"}}'

      - name: Verify package installed
        run: |
          cd test-project
          test -f vendor/blockstudio/blockstudio/blockstudio.php
          echo "Plugin files installed"

      - name: Verify autoloader resolves classes
        run: |
          cd test-project
          php -r "
            require 'vendor/autoload.php';
            require 'vendor/blockstudio/blockstudio/lib/tailwindphp-autoload.php';
            if (!class_exists('YahnisElsts\\\PluginUpdateChecker\\\v5\\\PucFactory')) {
              echo \"PucFactory not found\n\";
              exit(1);
            }
            echo \"Composer install: classes resolve\n\";
          "

      - name: Start MySQL
        run: |
          sudo systemctl start mysql
          mysql -u root -proot -e "CREATE DATABASE IF NOT EXISTS wordpress;"

      - name: Set up WordPress with Composer-installed plugin
        run: |
          mkdir wordpress && cd wordpress
          wp core download
          wp config create --dbname=wordpress --dbuser=root --dbpass=root
          wp core install --url=http://localhost --title=Test --admin_user=admin --admin_email=admin@test.com --admin_password=password --skip-email
          ln -s $GITHUB_WORKSPACE/test-project/vendor/blockstudio/blockstudio wp-content/plugins/blockstudio
          wp plugin activate blockstudio

      - name: Install test theme and verify block detection
        run: |
          cp -r repo/tests/theme wordpress/wp-content/themes/blockstudio-test
          cd wordpress
          wp theme activate blockstudio-test
          wp eval "
            \$registry = WP_Block_Type_Registry::get_instance();
            \$block = \$registry->get_registered('blockstudio/type-number');
            if (!\$block) {
              echo \"FAIL: blockstudio/type-number not registered\n\";
              exit(1);
            }
            echo \"Block registered: \" . \$block->name . \"\n\";
            echo \"Title: \" . \$block->title . \"\n\";
          "
